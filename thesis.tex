% **************************************************
% Document Class Definition
% **************************************************
\documentclass[%
	paper=A4,					% paper size --> A4 is default in Germany
	twoside=true,				% onesite or twoside printing
	openright,			.
	% doublepage cleaning ends up right side
	parskip=full,				% spacing value / method for paragraphs
	chapterprefix=true,			% prefix for chapter marks
	11pt,						% font size
	headings=normal,			% size of headings
	bibliography=totoc,			% include bib in toc
	listof=totoc,				% include listof entries in toc
	titlepage=on,				% own page for each title page
	captions=tableabove,		% display table captions above the float env
	draft=false,				% value for draft version
]{scrreprt}%

% **************************************************
% Debug LaTeX Information
% **************************************************
%\listfiles

% **************************************************
% Information and Commands for Reuse
% **************************************************
\newcommand{\thesisTitle}{Compliant Humanoid Robots:\\Simulation and Control}
\newcommand{\thesisName}{Alessio Rocchi}
\newcommand{\thesisSubject}{Robust Control Framework  and Simulation Techniques for Compliant Humanoid Robots with application to the Darpa Robotics Challenge}
\newcommand{\thesisDate}{11 November, 2015}
\newcommand{\thesisVersion}{Draft}

\newcommand{\thesisFirstReviewer}{Nikos G. Tsagarakis}
\newcommand{\thesisFirstReviewerUniversity}{\protect{Istituto Italiano di Tecnologia}}
\newcommand{\thesisFirstReviewerDepartment}{Advanced Robotics Department}

\newcommand{\thesisSecondReviewer}{Antonio Bicchi}
\newcommand{\thesisSecondReviewerUniversity}{\protect{Universit\`a di Pisa}}
\newcommand{\thesisSecondReviewerDepartment}{Centro E. Piaggio}

\newcommand{\thesisFirstSupervisor}{Nikos G. Tsagarakis}
\newcommand{\thesisSecondSupervisor}{Antonio Bicchi}

\newcommand{\thesisUniversity}{\protect{Universit\`a di Genova}}
\newcommand{\thesisUniversityDepartment}{Advanced Robotics Department}
\newcommand{\thesisUniversityInstitute}{Istituto Italiano di Tecnologia}
\newcommand{\thesisUniversityGroup}{Clean Thesis Group (CTG)}
\newcommand{\thesisUniversityCity}{Genova}
\newcommand{\thesisUniversityStreetAddress}{via Morego 30}
\newcommand{\thesisUniversityPostalCode}{16163}

% **************************************************
% Load and Configure Packages
% **************************************************
\usepackage[utf8]{inputenc}		% defines file's character encoding
\usepackage[english]{babel} % babel system, adjust the language of the content
\usepackage[					% clean thesis style
	figuresep=colon,%
	sansserif=false,%
	hangfigurecaption=false,%
	hangsection=true,%
	hangsubsection=true,%
	colorize=full,%
	colortheme=bluemagenta,%
	bibsys=bibtex,%
	bibfile=bib/refs,%
	bibstyle=alphabetic,%
]{cleanthesis}
\usepackage{amsmath, amssymb, bm}
\usepackage{comment}
\usepackage{graphicx, epsfig}
\usepackage{caption, subcaption, wrapfig}
\usepackage{array, makecell, multicol}
\usepackage[toc,page]{appendix}
\usepackage{rotating}
\usepackage[disable]{todonotes}
\usepackage{xr}

\hypersetup{					% setup the hyperref-package options
	pdftitle={\thesisTitle},	% 	- title (PDF meta)
	pdfsubject={\thesisSubject},% 	- subject (PDF meta)
	pdfauthor={\thesisName},	% 	- author (PDF meta)
	plainpages=false,			% 	-
	colorlinks=false,			% 	- colorize links?
	pdfborder={0 0 0},			% 	-
	breaklinks=true,			% 	- allow line break inside links
	bookmarksnumbered=true,		%
	bookmarksopen=true			%
}

% **************************************************
% Document CONTENT
% **************************************************
\begin{document}

% --------------------------
% rename document parts
% --------------------------
%\renewcaptionname{ngerman}{\figurename}{Abb.}
%\renewcaptionname{ngerman}{\tablename}{Tab.}
\renewcaptionname{english}{\figurename}{Fig.}
\renewcaptionname{english}{\tablename}{Tab.}

% --------------------------
% Front matter
% --------------------------
\pagenumbering{roman}			% roman page numbing (invisible for empty page style)
\pagestyle{empty}				% no header or footers
\input{content/titlepages}		% INCLUDE: all titlepages
\cleardoublepage

\pagestyle{plain}				% display just page numbers
\input{content/abstract}		% INCLUDE: the abstracts (english and german)
\cleardoublepage
%
\setcounter{tocdepth}{2}		% define depth of toc
\tableofcontents				% display table of contents
\cleardoublepage

% --------------------------
% Body matter
% --------------------------
\pagenumbering{arabic}			% arabic page numbering
\setcounter{page}{1}			% set page counter
\pagestyle{maincontentstyle} 	% fancy header and footer

\chapter{Introduction}
In the last years, a revolution took by the storm the robotics community. Large rounds of investments have pushed the boundaries of applied robotics in different fields: autonomous car driving in unstructured environments as fostered by the DARPA challenge first, humanoids working in disaster scenarios through the DARPA robotics challenge (DRC), a new round of big investments by the US government and Toyota in autonomous car driving.

In particular, in the field of humanoid robotics,  the DRC finals saw the partecipation of 25 teams~\cite{DRC-what-happened}, with entries presenting their own robot built from the ground up for the competition, while others only focusing on the software development for algorithms in the fields of low and high level control \cite{beeson15, feng2015-rj, feng2015-oj}, planning, sensing and artificial intelligence, as well as teleoperation interfaces, transmission on degraded channels for teleoperation and sensing \cite{fallon2015-ni}, automated testing infrastractures, control frameworks, and simulation techniques for fast and robust simulation.

As part of the FP7 european project WALK-MAN, the WALK-MAN team has been funded to speed up the progress on the project in order to partecipate in the important DRC competition as an early demonstrator of the capabilities of the WALK-MAN robot and its infrastracture.

Part of the team took care of designing the robot, with the simulator in the loop in order to check the design against the task requirements set forth by the WALK-MAN project and by the DRC, a new SEA joint design has been created and a new network architecture for low-level control has been developed, based on ETHERCAT. 

At the same time, the efforts of the iCub facility in the development of the YARP intrastructure and the iCub project have been integrated with the COMAN robot first, and the WALK-MAN robot afterwards. The \emph{robotInterface} have been integrated and tested together with the partners at iCub facility to interface the low level control algorithms in the control boards of the two robots with the YARP interfaces for high level control. 

Meanwhile, YARP plugins for the Gazebo simulator have been developed, in order to provide an easy to use framework where task developers could test their code prior to use the robot, a precious resource which needed to be carefully assigned to all the subgroups in the WALK-MAN team, as well as the other researchers in the department that needed to perform research work on the robot. At the same time, the models for the robot have been developed so that to be compatible with the new simulator and with the growing codebase of the iDynTree library, providing kinematics and dynamics quantities for the robot to be used by the tasks developers. Both the models, simulator and the high level YARP interfaces have been designed and configured in order to allow the testing and development of algorithms incrementally, starting from just the upper or lower body of the robot in order to allow manipulation and locomotion groups to work independently in the first part of development to maximize productivity. 

In the meantime, the whole body framework OpenSoT has been developed in order to provide an high level task specification framework that could exploit the full capabilities of the robot in a whole-body fashion. From the developmenf of OpenSoT stemmed a set of tools that include task previewing, simplified geometries computation for collision detection, logging and plotting frameworks at the task and data level, and interfaces for different programming language for easy task prototyping. Together with the framework, high level control and modeling libraries, iDynUtils and RobotUtils were developed to integrate and easily provide functionalities based off popular robotics libraries (e.g. PCL, iDynTree, moveit) and build new ones such as dead reckoning based on the forward kinematics of the robot, whole body interaction with the environment by using anchor points to execute motions in intermittent multi-contact scenarios (such as the rising up motion that was part of the qualification videos for the team). 

All these fundamental libraries have been subject to intensive testing, useful both for agile development in such a big team (unit testing) and as regression tests during the integration phases. Together with these tools, a build system has been setup together with iCub facility to ease the development of an always growing codebase with complicated interdependencies, resulting in the establishment of a so-called \emph{superbuild} system that allowed new developers to easily join in, by downloading, compiling or installing all the parts of the WALK-MAN software ecosystem in less than one hour. A component model, \emph{GYM} has been developed in the meantime to streamline module development, with features like easy configuration managament, standardized commands for interaction with modules, graphical tools for plotting and on-line gain and parameters tuning for the algorithms and the modules containing them, a standardized state machine, communication channels for working on degraded networks. At the same time, a teleoperation graphical interface, the pilot interface \emph{PI} has been developed in order to provide graphical interfaces to all the modules to enable fast, practical and reactive teleoperation by the robot pilot team.

While the infrastracture was being built, development on the basic modules progressed. While it took more than 4 months to develop first version of the valve and locomotion modules, it took less than 2 months to develop the door opening task, and around one month for the car driving task, the drilling/one hand valve opening task. This can be attributed to the growing maturity of the infrastructure which allowed faster developmenf times while taking advantage of mature high level control schemes. Furthermore, the architecture allowed to switch from the COMAN robot to the WALK-MAN robot with minimum effort, allowing to focus on the practical issues of debugging the new hardware, on the mechanical/electric and computational/networking aspects.

In the following thesis, elements of this work will be described in more depth, and in particular some details will be given about the simulation software developed, the high level whole-body control framework OpenSoT, and the software infrastracture developed.

\section{Simulation}
Simulation techniques for modern robot hardware could provide invaluable tools for design, research, and development for robot controllers.  The DARPA Robotics Challenge (DRC), for example, fostered significant investment in reliable simulation tools for humanoid robots~\cite{Hsu14}, which allowed teams to compete virtually (the Virtual Robotics Challenge, VRC) before qualifying for expensive robot hardware.  Gazebo~\cite{Koenig08} is one of the most popular general-purpose robot simulators, funded through DRC efforts, but there are several others including V-REP and Webots.  A few robot simulators and toolkits are specialized in grasping, such as GraspIt!~\cite{Miller04}, OpenRave~\cite{Diankov08OpenRAVE} and OpenGRASP~\cite{Leon10OpenGRASP}, which have built-in functionality for grasp analysis. However, these prior methods assume fully and precisely actuated grippers. 

In \ref{simulator} we will present the work on the Gazebo simulator, which has been chosen as the WALK-MAN and COMAN simulation environment also in light of its role as the official simulator for the VRC competition. Results on robust simulation of underactuated compliant hands will be showed.

\section{Control}
The field of whole-body planning and control tries to find the solution to the problem of executing one or more task at the same time, while exploiting the capabilities of the entire body of redundant, floating-based robots in multi-contact scenarios with the environment.
Resolved velocity control is a popular choice for high level robot controllers, with latest trends both in research and application making use of Quadratic Programming (QP) to obtain a locally optimal solution to the hierarchical constrained IK problem. The interest is in part justified by the need, for practical reasons, to have robust solutions which are hard constrained by the physical limits of the robots, such as joint, torque and self-collision avoidance limits.
In \ref{opensot} the whole-body control framework OpenSoT will be presented, with focus on the implemented resolved velocity control schemes, compliant kinematic control schemes, and force control through admittance control. In \ref{architecture} more details will be provided on how the algorithms developed for simulation and whole-body control fit in a large-scale humanoid architecture developed for robust control of the humanoid robots at the \emph{Department of Advanced Robotics} of the \emph{Istituto Italiano di Tecnologia}.

 
\chapter{Simulation of Compliant Robots}
\label{simulator}
\input{simulator}

\chapter{Whole-Body Control}
\label{opensot}
\input{opensot}

\chapter{Humanoids Software Architecture}
\label{architecture}
\input{architecture}

\chapter{Conclusions}
\externaldocument{opensot}
In this work, part of the results of the effort on the Darpa Robotics Challenge for team WALK-MAN have been presented.
Some of the results have been obtained in an attempt to engineer the state of the art in humanoid robotics.
As previously highlighted, even though the research work in the humanoid robotics field is varied and is carried over by many laboratories around the world following different approaches, one of the surprising points of the competition lied in the fact that the final control architecture adopted by many teams tended to be very similar. One could argue how this showed a significant cap put by technology on the physical implementation of the state of the art of robotic control and planning.

On the more generic topic concerning the coordination of the team for the DRC competition, a significant experience has been gained on the field:
\begin{itemize}
 \item we learnt that most humanoid robots are more robust than what we expected, with lots of falls during the Darpa Robotics Challenge not being fatal to the hardware. In particular, the WALK-MAN robot fell graciously, in part thanks to its actuation design, and did not suffer significant damage to the structure, actuators or sensors. The foam padding and the cage structure protecting the head also played an important role for the structural integrity of the robot after falling.
 \item leading change is very difficult. Streamlining a development cycle has encountered the resistance of the group initially, while has proven fundamental and much appreciated later on. In particular, switching from a hand-made per-module development workspace to an automatic building system with dependency resolution (using YCM) has been a great challenge.
 \item one of the critical points in our software infrastracture revealed itself at the wake of the DRC finals: for performance reasons, the initial design consisting of one YARP control board for every kinematic chain of the robot (which implies creating 6 threads on the control computer, with 6 different set of ports streaming sensors data and receiving input commands for all the joints of that particular kinematic chain) has been substituted with a final setup with just a single Control Board for every joint in the robot. As a result, while having multiple kinematic chains allowed to control the robot even with missing limbs (i.e., during the initial development phase, were using only the lower body or only the upper body gave chance to the manipulation and locomotion teams to work independently as if having two different robots), the final setup was less demanding of the limited resources of the on-board computer and allowed jitter-less 1Khz control on the low-latency Linux kernel. This implied also adapting the \emph{RobotUtils} middleware to the new network configuration, as the middleware was not updated on time to be topology-agnostic(that is, to be configurable for different Control Board designs) - finally the middleware had to be hardcoded to support the new robot configuration, with severe drawbacks in the overall software architecture and consequently on the productivity of researchers using the software stack (e.g., the need to change the code when switching from simulation to physical robot). Thus, the lesson learnt was that configurability of topology at every layer in the architecture is very important, especially when building a new robot, were computing requirements and kinematic and network topology might change due to maintenance, changing requirements or debugging.
\end{itemize}


Regarding simulation, we had very promising results and had a great adoption rate to the simulator and relative tooling, which soon become irreplaceable. Researchers experience great benefits from previewing their work with a visual, dynamic simulator, where the code used to move the robot in simulation was the same used for the physical robot. Ongoing work is progressing in the study of  more faithful simulation techniques for compliant robots, were also the dynamics of the motor in a SEA joint are taken into account. Still, a significant amount of work should be invested in obtaining proper simulation tools for underactuated and compliant hands, in particular questions arise on the grade of fidelity one might obtain with such methods, and to answer this question we should first resort to fine identification of the hand model used in simulation, together with some fundamental object/hand properties like friction. This remains an open area of work.

On the OpenSoT front, the experience during the development and use of the library have been very valuable:
\begin{itemize}
 \item even though a library is built with ambitious goals for flexibility, adaptability and sharability, in fact the research community is not apt to adopting standards which are built by possible competitors, unless it is addressed specifically in a formal scientific collaboration. On the other side, the ROS ecosystem over the years gained increasingly more ground as a platform for sharing software modules, and as a means to compose them to obtain high level, complex robotic systems. Of course, in general the community of researches expert in one field and the community of users of the products of that field belong to two different scenarios that intersect only in some circumstances. One idea for the future is to export the OpenSoT functionalities as a MoveIt plugin, in order to provide a robust whole-body framework which is ready to use for the large community of ROS users.
 \item it is very difficult in the research community to make sound statements about the robustness of software. In some cases, the software is seen as a byproduct of a theoretical development in a certain field, so that criticizing the software in terms of robustness it's often not possible or easy to do. A large part of the community can recognize a strong theoretical contribution, but fails at recognizing the value of research work in applied engineering. The Darpa Robotics Challenge very clearly pushed the community to distinguish the research and technology that works reliably in the physical world from that which belongs only to the lab. More and more robotics challenges are being organized yearly, with the hope that the community will gain more awareness and sensibility to the problem of implementing research on a physical robot.
 \item while the field of resolved velocity control is still not exhausted (see recent results in learning, task specification, robust constraint specification \cite{del2015robustness} in constrained control problems), the next step in frameworks like OpenSoT is not strictly in control, but in sensing. Many groups work in sensing and estimation, and in order to obtain more robust control it is important to have good state observers and estimators. Our experience showed that without filtering, tools like the dynamics constraint implemented in our robots can show jittety behaviors. At the moment, the solution in this cases where good joint velocity and torque estimates was needed, was to set gains which were more forgiving, or to relax the constraints.
 \item while many might argue that different formulations of the hiearchical constrained resolved velocity control might result in an unfeasible problem (e.g. hard constraints vs slack variable minimization), very often the problem  of unfeasibility boils down to being a design decision rather than a formulation problem. For example, even when the constraints are hard, meaning that breaking those contraints results in obtaining no solution from the IK solver, the unfeasibility problem has a physical meaning which is not just mathematical, and entails practical questions such as: what strategy should to adopt when it's detected that the robot is going to fall, what should happen when (for whichever reason) the joint configurations are found to be out of the designed safety limits, or when joints are exerting torques which are greater than planned? In some of these cases, in our experience we kept unfeasibility by design, in some other cases we relaxed a constraint. More in practice, in OpenSoT the joint limit constraints are hard constraints, so in some circumstances, because of the compliant joints, the robot might start in a configuration from which no solution to the IK is feasible, and contingency actions can be taken after an human operator verifies the situation. On the other side, the dynamics constrained has been relaxed so as to be always feasible. In fact, the dynamics constraint is in general a \emph{repulsive} constraint, meaning that even when the IK solution minimizing the task error might impose a joint to move in a certain direction, the constraint might ask the joint to move in the opposite direction. Sometimes, the speed at which the constraint imposes the joint movement is too high and goes in conflict with the joint velocity limits, making the problem unfeasible. For example, imagine having a pendulum with a heavy weight attached to its extremity, and a torque limit constraint on its joint. When the pendulum is at rest at the configuration of maximum torque, the torque limit might ask us to accelerate downwards in order to decrese the load on the motor. Still, the requested movement might be unfeasible for the joint velocity limit constraint. In a way, this highlights the need of enforcing priority even between constraints. We implemented this by relaxing the dynamics (or torque limits) constraint as to alway impose velocities which are also feasible for the higher priority constriants (which, in this case, is the joint velocity limits).
 \item while the admittance control scheme that is implemented by the \emph{Interaction} task (paragraph \ref{par:interaction}) works well in most cases, it still does not work for controlling ground reaction forces when in double support phase with no other external contacts. A more generic approach should be considered to obtain either whole-body hybrid position/force control, or force and position control through a whole-body admittance or compliance control.
 \item while task specification is relatively easy to implement, gain tuning and priority tuning is a major problem when designing a stack. Furthermore, task designers require in some cases stacks able perform a particular motion or a set of motions in a human-like manner, and while we can anticipate this need will become more and more significant as service robotics progresses into the house, it is difficult or impossible to design human-like motions in terms of simple cost functions and hand-tuning of gains. In the same way, it is relatively difficult to design stacks that perform well globally, or in other words, trajectories should not be generated exclusively by a local optimization method (like the one used in OpenSoT), but a planner should provide setpoints for the controller. In both cases, planning of the gains and priorities could be an area of work, be either by means of optimal control, sampling-based planning or machine learning techniques.
\end{itemize}
Future work for the framework might include implementing more powerful minimum effort and posture optimization tasks, based on grasp theory. Preliminary results show the possibility to implement a constrained minimum effort task that minimizes the effort of actuators in face of any expected or measured force in any point of the body of the robot.
\cleardoublepage

% --------------------------
% Back matter
% --------------------------
{%
\setstretch{1.1}
\renewcommand{\bibfont}{\normalfont\small}
\setlength{\biblabelsep}{0pt}
\setlength{\bibitemsep}{0.5\baselineskip plus 0.5\baselineskip}
\printbibliography[nottype=online]
\printbibliography[heading=subbibliography,title={Websites},type=online,prefixnumbers={@}]
}
\cleardoublepage

%\listoffigures
%\cleardoublepage

%\listoftables
%\cleardoublepage

%\input{content/colophon}
%\cleardoublepage

%\input{content/declaration}
%\clearpage
%\newpage
%\mbox{}

% **************************************************
% End of Document CONTENT
% **************************************************
\end{document}
